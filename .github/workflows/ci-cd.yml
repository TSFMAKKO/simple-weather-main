name: æŒçºŒæ•´åˆ (CI/CD)

on:
  push:
    branches: [main]        # ç•¶ main åˆ†æ”¯æœ‰ push æ™‚è§¸ç™¼
  pull_request:             # ç•¶å»ºç«‹ PR æ™‚è§¸ç™¼
  workflow_dispatch:        # å¯ä»¥æ‰‹å‹•è§¸ç™¼ workflow

permissions:
  contents: write           # å…è¨±éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯

jobs:
  ci:
    name: å»ºç½®èˆ‡æª¢æŸ¥ç’°å¢ƒ
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è¼‰ç¨‹å¼ç¢¼å€‰åº«
        uses: actions/checkout@v6

      - name: æª¢æŸ¥ç¨‹å¼ç¢¼å€‰åº«ç‹€æ…‹
        run: |
          echo "ğŸ“‹ ä½œæ¥­ç³»çµ±è³‡è¨Š"
          cat /etc/os-release

          echo ""
          echo "ğŸ“‚ ç›®å‰å·¥ä½œç›®éŒ„"
          pwd

          echo ""
          echo "ğŸ“ ç›®éŒ„æª”æ¡ˆåˆ—è¡¨"
          ls -al

          echo ""
          echo "ğŸŒ¿ Git åˆ†æ”¯è³‡è¨Š"
          git branch -vv

      - name: è¨­å®š Node.js ç’°å¢ƒ
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£ç›¸ä¾å¥—ä»¶
        run: npm ci

      - name: Lint æª¢æŸ¥
        run: npm run lint

  deploy:
    name: éƒ¨ç½²åˆ° GitHub Pages
    runs-on: ubuntu-latest
    needs: ci          # ä¾è³´ CI job æˆåŠŸ

    steps:
      - name: æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        run: |
          # æª¢æŸ¥ vars
          if [ -z "${{ vars.VITE_OPEN_WEATHER_API_URL }}" ]; then
            echo "âŒ Error: VITE_OPEN_WEATHER_API_URL è®Šæ•¸æœªè¨­å®š"
            exit 1
          else
            echo "âœ… VITE_OPEN_WEATHER_API_URL å·²è¨­å®š: ${{ vars.VITE_OPEN_WEATHER_API_URL }}"
          fi

          # æª¢æŸ¥ secrets (ä¸é¡¯ç¤ºå€¼)
          if [ -z "${{ secrets.VITE_OPEN_WEATHER_API_KEY }}" ]; then
            echo "âŒ Error: VITE_OPEN_WEATHER_API_KEY secret æœªè¨­å®š"
            exit 1
          else
            echo "âœ… VITE_OPEN_WEATHER_API_KEY å·²è¨­å®š"
          fi

      - name: ä¸‹è¼‰ç¨‹å¼ç¢¼å€‰åº«
        uses: actions/checkout@v6

      - name: è¨­å®š Node.js ç’°å¢ƒ
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: å®‰è£ä¾è³´ä¸¦å»ºç½®
        env:
          VITE_OPEN_WEATHER_API_URL: ${{ vars.VITE_OPEN_WEATHER_API_URL }}
          VITE_OPEN_WEATHER_API_KEY: ${{ secrets.VITE_OPEN_WEATHER_API_KEY }}
        run: |
          npm ci
          npm run build

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages       # éƒ¨ç½²ç›®æ¨™åˆ†æ”¯
          folder: dist           # å»ºç½®ç”¢ç‰©ç›®éŒ„